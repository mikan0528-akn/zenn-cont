---
title: "GoogleWorkspaceでのDKIM・DMARCの設定方法"
emoji: "📬"
type: "tech" # tech: 技術記事 / idea: アイデア
topics: [googleworkspace,dkim,dmarc]
published: false
---

:::message
SPFについてはMXの自動設定時に設定されているため、操作は不要です
:::

メールでやりとりするにあたってDKIMなどのセキュリティ設定は必須です
めんどくさいですが、設定しないと色々と危ないので必ず設定しましょう
# そもそもDKIM・DMARCとは？
## DKIMとは？
DKIM（DomainKeys Identified Mail）とは、電子メールでの送信ドメイン認証技術です。
メール送信者が送信するメールに電子署名を行い、受診者が電子署名を検証することによりなりすましや内容の改ざん等が無いことを検証できます。
この検証に失敗した場合は、受信拒否などがされる場合があります。
電子署名には公開鍵が使用されており、こちらはDNSサーバーにて公開されます。
## DMARCとは？
DMARC（Domain-based Message Authentication, Rporting, and Conformance）も、電子メールでの送信ドメイン認証技術です。
DMARCは、SPFやDKIMのドメイン認証を補強する技術です。このため、DMARCを使用するにはSPFとDKIMの設定が必須になります。
SPF・DKIMでは送信者側が認証結果を知ることはできませんでしたが、DMARCを使用することにより、認証結果を知ることができ、メールシステムが正しく動いているかなどの判断が容易になります。
# DKIMを設定する

https://support.google.com/a/answer/174124

## 1.事前の確認事項
事前にこちらを確認してください
- DNSレコードが編集できるかどうか
- DNSレコードの提供元が2048ビットのDKIM鍵に対応してるかどうか
- 送信ゲートウェイの設定がDKIMに干渉しないかどうか
- 既に設定していないかどうか
## 2.DKIM鍵を生成する
まず最初に、[GoogleWorkspace 管理コンソール](https://admin.google.com)に移動してDKIM鍵を取得します
アプリ→GoogleWorkspace→Gmailより、以下の画面に移動します
![](/images/0c10d8df0b06f8/image(1).png)
メニューにあるメールの認証を押し、この画面に移動します
こちらの画面で「新しいレコードを作成」をクリックし、DKIM鍵を生成します。
DKIM鍵のビット長は、基本的に2028を選択してください。
![](/images/0c10d8df0b06f8/image(2).png)
メールの認証に表示されている「DNSホストの名前（TXTレコード名）」と「TXTレコードの値」を控えておいてください。
## 3.DNSレコードに鍵を追加する
DNSレコードを管理しているサービスに移動し、新しいレコードを作成します。
レコードの内容は以下のとおりです
|種類|ホスト名|値|
|:---:|:---:|:---:|
|TXT|先程コピーした「DNSホストの名前」|先程コピーした「TXTレコードの値」|
## 4.DKIMを有効化する
先程のGoogleWorkspace管理コンソールに戻り、下部にある「認証を開始」をクリックして有効化します
![](/images/0c10d8df0b06f8/image(3).png)
ステータスが「DKIMでメールを認証しています。」になれば完了です
## 5.DKIM認証の確認をする
別のGoogleアカウントへテストメールを送信します
受信側にてテストメールを開き、その他アイコンから「メッセージのソースを表示」をクリックします
このように表示されれば成功です
![](/images/0c10d8df0b06f8/image(4).png)

# DMARCの設定をする
:::message alert
DKIMとSPFの設定から48時間間を空けて設定してください
:::

https://support.google.com/a/answer/2466580

## 1.事前の確認事項
- SPFとDKIMが設定してあるかどうか
- レポート用のメールボックスを作成する(推奨)
- DNSレコードを編集できるかどうか
- 既にDMARCが設定してあるかどうか
## 2.レコードを作成する
DNSレコードを管理しているサービスにログインし、編集画面に移動します。
その後、以下のように入力します
|種類|レコード名|値|
|:---:|:---:|:---:|
|TXT|_dmarc|v=DMARC1; p=none; rua=mailto:dmarc@hogehoge.com|

**※レコードの値は一例です。ドメイン等を変更しないとレポートが届きません**
## 3.DMARC認証の確認をする
DKIM認証のときと同様にテストメールを送信し、受診者側にてテストメールのソースを確認します。
このように表示されていれば成功です。
![](/images/0c10d8df0b06f8/image(5).png)
